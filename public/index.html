<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÉ Run! Run!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #90EE90 70%, #228B22 100%);
            min-height: 100vh;
            color: white;
            overflow: hidden;
        }
        
        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 1000;
            text-shadow: 2px 2px 0px #000;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            padding: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .screen.active {
            display: flex;
        }
        
        .game-over-screen {
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid #ff0000;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
        }
        
        .results-screen {
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid #00ff00;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
        }
        
        .login-screen, .register-screen, .main-menu, .profile-screen, .lobby-screen {
            background: #000;
            border: 8px solid #666;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
            max-width: 600px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #00ff00;
            font-size: 10px;
        }
        
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 2px solid #666;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            border-radius: 5px;
        }
        
        input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0,255,0,0.3);
        }
        
        .btn {
            background: linear-gradient(to bottom, #ff6b6b, #ee5a52);
            border: 3px solid #fff;
            color: white;
            padding: 12px 24px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
            border-radius: 8px;
            margin: 5px;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .btn:hover {
            background: linear-gradient(to bottom, #ff5252, #d32f2f);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(to bottom, #45a049, #3d8b40);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: #222;
            border: 2px solid #444;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 16px;
            color: #00ff00;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 8px;
            color: #ccc;
        }
        
        .friends-list {
            background: #111;
            border: 2px solid #333;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .friend-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .friend-item:last-child {
            border-bottom: none;
        }
        
        .friend-name {
            color: #00ff00;
            font-size: 8px;
        }
        
        .friend-stats {
            color: #888;
            font-size: 6px;
        }
        
        .room-info {
            background: #222;
            border: 2px solid #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .players-list {
            margin: 15px 0;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #333;
            border-radius: 5px;
        }
        
        .player-ready {
            background: #2d5a2d;
        }
        
        .ready-status {
            font-size: 6px;
            color: #00ff00;
        }
        
        .error {
            color: #ff4444;
            background: #441111;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 8px;
            border: 1px solid #ff4444;
        }
        
        .success {
            color: #44ff44;
            background: #114411;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 8px;
            border: 1px solid #44ff44;
        }
        
        .game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #87CEEB;
            display: none;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        .game-canvas.active {
            display: block;
        }
        
        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            color: white;
            text-shadow: 2px 2px 0px #000;
            font-size: 10px;
        }
        
        .menu-title {
            font-size: 12px;
            margin-bottom: 20px;
            text-align: center;
            color: #00ff00;
        }
        
        .back-btn {
            background: linear-gradient(to bottom, #666, #444);
            font-size: 6px;
            padding: 8px 16px;
        }
        
        .back-btn:hover {
            background: linear-gradient(to bottom, #777, #555);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÉ RUN! RUN! üèÉ</h1>
        </div>
        
        <div class="screen login-screen active" id="loginScreen">
            <h2 class="menu-title">Login</h2>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="loginUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <div id="loginError" class="error" style="display: none;"></div>
            <button class="btn" onclick="login()">Login</button>
            <button class="btn btn-secondary" onclick="showRegister()">Register</button>
        </div>
        
        <div class="screen register-screen" id="registerScreen">
            <h2 class="menu-title">Create Account</h2>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="registerUsername" placeholder="Choose username">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="registerEmail" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="registerPassword" placeholder="Choose password">
            </div>
            <div id="registerError" class="error" style="display: none;"></div>
            <button class="btn" onclick="register()">Create Account</button>
            <button class="btn back-btn" onclick="showLogin()">Back to Login</button>
        </div>
        
        <div class="screen main-menu" id="mainMenu">
            <h2 class="menu-title">Main Menu</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number" id="userGamesPlayed">0</div>
                    <div class="stat-label">Games Played</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="userGamesWon">0</div>
                    <div class="stat-label">Games Won</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="userWinRate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
            </div>
            
            <button class="btn" onclick="createRoom()">Create Game Room</button>
            <button class="btn" onclick="showJoinRoom()">Join Game Room</button>
            <button class="btn btn-secondary" onclick="showProfile()">View Profile</button>
            <button class="btn btn-secondary" onclick="showFriends()">Friends</button>
            <button class="btn back-btn" onclick="logout()">Logout</button>
            
            <div id="joinRoomDiv" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label>Room Code:</label>
                    <input type="text" id="roomCodeInput" placeholder="Enter room code">
                </div>
                <button class="btn" onclick="joinRoom()">Join Room</button>
                <button class="btn back-btn" onclick="hideJoinRoom()">Cancel</button>
            </div>
        </div>
        
        <div class="screen profile-screen" id="profileScreen">
            <h2 class="menu-title">Player Profile</h2>
            <div id="profileInfo"></div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label>Add Friend:</label>
                <input type="text" id="friendUsername" placeholder="Enter username">
                <button class="btn" onclick="addFriend()">Add Friend</button>
            </div>
            
            <div id="friendsListDiv">
                <h3 style="color: #00ff00; margin: 20px 0 10px 0; font-size: 10px;">Friends List</h3>
                <div class="friends-list" id="friendsList"></div>
            </div>
            
            <div id="profileMessage" style="margin: 10px 0;"></div>
            <button class="btn back-btn" onclick="showMainMenu()">Back to Menu</button>
        </div>
        
        <div class="screen lobby-screen" id="lobbyScreen">
            <h2 class="menu-title">Game Lobby</h2>
            <div class="room-info">
                <div style="color: #00ff00; margin-bottom: 10px;">Room Code: <span id="roomCode"></span></div>
                <div class="players-list" id="playersList"></div>
                <button class="btn" onclick="toggleReady()">Ready/Unready</button>
                <button class="btn back-btn" onclick="leaveRoom()">Leave Room</button>
            </div>
            <div id="lobbyMessage"></div>
        </div>
        
        <div class="screen game-over-screen" id="gameOverScreen">
            <h2 style="color: #ff0000; margin-bottom: 20px;">GAME OVER!</h2>
            <p style="margin-bottom: 20px; font-size: 8px;">You were eliminated!</p>
            <p style="margin-bottom: 20px; font-size: 6px;">Waiting for other players to finish...</p>
            <div id="gameOverMessage"></div>
        </div>
        
        <div class="screen results-screen" id="resultsScreen">
            <h2 style="color: #00ff00; margin-bottom: 20px;">RACE COMPLETE!</h2>
            <div id="raceResults"></div>
            <button class="btn" onclick="playAgain()">Play Again</button>
            <button class="btn btn-secondary" onclick="returnToHub()">Return to Hub</button>
        </div>
        
        <canvas id="gameCanvas" class="game-canvas" width="1000" height="600"></canvas>
        
        <div class="game-ui" id="gameUI" style="display: none;">
            <div>Distance: <span id="distanceCounter">0</span>m</div>
            <div>Players Alive: <span id="playersAlive">0</span></div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let currentUser = null;
        let socket = null;
        let currentRoom = null;
        let gameState = {
            players: new Map(),
            gameStarted: false,
            camera: { x: 0, y: 0 },
            enemies: [],
            worldWidth: 5000
        };
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            if (screenId === 'gameCanvas') {
                document.getElementById('gameCanvas').classList.add('active');
                document.getElementById('gameUI').style.display = 'block';
            } else {
                document.getElementById('gameCanvas').classList.remove('active');
                document.getElementById('gameUI').style.display = 'none';
                document.getElementById(screenId).classList.add('active');
            }
        }
        
        function showLogin() {
            showScreen('loginScreen');
        }
        
        function showRegister() {
            showScreen('registerScreen');
        }
        
        function showMainMenu() {
            showScreen('mainMenu');
            updateUserStats();
        }
        
        function showProfile() {
            showScreen('profileScreen');
            loadProfile();
        }
        
        function showFriends() {
            loadFriends();
        }
        
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    localStorage.setItem('token', data.token);
                    initializeSocket();
                    showMainMenu();
                } else {
                    showError('loginError', data.error);
                }
            } catch (error) {
                showError('loginError', 'Connection error');
            }
        }
        
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    localStorage.setItem('token', data.token);
                    initializeSocket();
                    showMainMenu();
                } else {
                    showError('registerError', data.error);
                }
            } catch (error) {
                showError('registerError', 'Connection error');
            }
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('token');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            showLogin();
        }
        
        function updateUserStats() {
            if (currentUser) {
                document.getElementById('userGamesPlayed').textContent = currentUser.gamesPlayed;
                document.getElementById('userGamesWon').textContent = currentUser.gamesWon;
                const winRate = currentUser.gamesPlayed > 0 ? 
                    ((currentUser.gamesWon / currentUser.gamesPlayed) * 100).toFixed(1) : 0;
                document.getElementById('userWinRate').textContent = winRate + '%';
            }
        }
        
        async function loadProfile() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/profile/${currentUser.username}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('profileInfo').innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-number">${data.gamesPlayed}</div>
                                <div class="stat-label">Games Played</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${data.gamesWon}</div>
                                <div class="stat-label">Games Won</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${data.winRate}%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
            
            loadFriends();
        }
        
        async function loadFriends() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/friends', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const friends = await response.json();
                
                if (response.ok) {
                    const friendsList = document.getElementById('friendsList');
                    friendsList.innerHTML = '';
                    
                    if (friends.length === 0) {
                        friendsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888; font-size: 8px;">No friends added yet</div>';
                    } else {
                        friends.forEach(friend => {
                            const winRate = friend.gamesPlayed > 0 ? 
                                ((friend.gamesWon / friend.gamesPlayed) * 100).toFixed(1) : 0;
                            
                            friendsList.innerHTML += `
                                <div class="friend-item">
                                    <div class="friend-name">${friend.username}</div>
                                    <div class="friend-stats">${friend.gamesWon}W/${friend.gamesPlayed}P (${winRate}%)</div>
                                </div>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }
        
        async function addFriend() {
            const friendUsername = document.getElementById('friendUsername').value.trim();
            if (!friendUsername) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/add-friend', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ friendUsername })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('profileMessage').innerHTML = 
                        '<div class="success">Friend added successfully!</div>';
                    document.getElementById('friendUsername').value = '';
                    loadFriends();
                } else {
                    document.getElementById('profileMessage').innerHTML = 
                        `<div class="error">${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('profileMessage').innerHTML = 
                    '<div class="error">Connection error</div>';
            }
        }
        
        function initializeSocket() {
            socket = io();
            
            socket.on('room-created', (data) => {
                currentRoom = data.roomId;
                document.getElementById('roomCode').textContent = data.roomId;
                showScreen('lobbyScreen');
            });
            
            socket.on('room-updated', (room) => {
                updateLobby(room);
            });
            
            socket.on('game-start', (room) => {
                startMultiplayerGame(room);
            });
            
            socket.on('player-moved', (data) => {
                updatePlayerPosition(data);
            });
            
            socket.on('player-eliminated', (data) => {
                if (data.username === currentUser.username) {
                    showGameOver();
                } else {
                    removePlayer(data.username);
                }
            });
            
            socket.on('game-end', (results) => {
                showGameResults(results);
            });
            
            socket.on('error', (message) => {
                document.getElementById('lobbyMessage').innerHTML = 
                    `<div class="error">${message}</div>`;
            });
        }
        
        function createRoom() {
            if (socket && currentUser) {
                socket.emit('create-room', { username: currentUser.username });
            }
        }
        
        function showJoinRoom() {
            document.getElementById('joinRoomDiv').style.display = 'block';
        }
        
        function hideJoinRoom() {
            document.getElementById('joinRoomDiv').style.display = 'none';
        }
        
        function joinRoom() {
            const roomCode = document.getElementById('roomCodeInput').value.trim();
            if (roomCode && socket && currentUser) {
                socket.emit('join-room', { 
                    roomId: roomCode, 
                    username: currentUser.username 
                });
                currentRoom = roomCode;
                document.getElementById('roomCode').textContent = roomCode;
                showScreen('lobbyScreen');
                hideJoinRoom();
            }
        }
        
        function toggleReady() {
            if (socket && currentRoom) {
                socket.emit('player-ready', { roomId: currentRoom });
            }
        }
        
        function leaveRoom() {
            currentRoom = null;
            showMainMenu();
        }
        
        function updateLobby(room) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            room.players.forEach(player => {
                const readyClass = player.ready ? 'player-ready' : '';
                const readyText = player.ready ? 'READY' : 'NOT READY';
                
                playersList.innerHTML += `
                    <div class="player-item ${readyClass}">
                        <div class="friend-name">${player.username}</div>
                        <div class="ready-status">${readyText}</div>
                    </div>
                `;
            });
            
            const allReady = room.players.every(p => p.ready);
            const enoughPlayers = room.players.length >= 2;
            
            if (allReady && enoughPlayers) {
                document.getElementById('lobbyMessage').innerHTML = 
                    '<div class="success">All players ready! Starting game...</div>';
            }
        }
        
        function showGameOver() {
            showScreen('gameOverScreen');
        }
        
        function showGameResults(results) {
            showScreen('resultsScreen');
            
            let html = '';
            results.forEach((result, index) => {
                let medal = '';
                if (result.position === 1) medal = 'ü•á';
                else if (result.position === 2) medal = 'ü•à';
                else if (result.position === 3) medal = 'ü•â';
                else medal = `${result.position}th`;
                
                html += `
                    <div class="player-item" style="margin: 10px 0;">
                        <div>${medal} ${result.username}</div>
                    </div>
                `;
            });
            
            document.getElementById('raceResults').innerHTML = html;
        }
        
        function playAgain() {
            if (socket && currentRoom) {
                socket.emit('play-again', { roomId: currentRoom });
                showScreen('lobbyScreen');
            }
        }
        
        function returnToHub() {
            currentRoom = null;
            showMainMenu();
        }
        
        function startMultiplayerGame(room) {
            showScreen('gameCanvas');
            initializeGame(room);
        }
        
        function initializeGame(room) {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const characters = [
                { 
                    name: 'Red Knight', 
                    bodyColor: '#FF0000', 
                    armorColor: '#8B0000',
                    accessory: 'helmet'
                },
                { 
                    name: 'Blue Mage', 
                    bodyColor: '#0066FF', 
                    armorColor: '#003399',
                    accessory: 'hat'
                },
                { 
                    name: 'Green Archer', 
                    bodyColor: '#00AA00', 
                    armorColor: '#006600',
                    accessory: 'hood'
                },
                { 
                    name: 'Yellow Warrior', 
                    bodyColor: '#FFAA00', 
                    armorColor: '#CC8800',
                    accessory: 'crown'
                },
                { 
                    name: 'Purple Rogue', 
                    bodyColor: '#AA00AA', 
                    armorColor: '#660066',
                    accessory: 'mask'
                }
            ];
            
            let players = new Map();
            let myPlayer = null;
            let gameRunning = true;
            let finishedPlayers = [];
            let enemies = [];
            let camera = { x: 0, y: 0 };
            let keys = {};
            
            const GRAVITY = 0.8;
            const JUMP_FORCE = -18;
            const MOVE_SPEED = 7;
            const WORLD_WIDTH = 5000;
            const FINISH_LINE = WORLD_WIDTH - 200;
            
            class Player {
                constructor(username, characterIndex, isMe = false) {
                    this.username = username;
                    this.x = 100;
                    this.y = canvas.height - 200;
                    this.width = 24;
                    this.height = 40;
                    this.velocityX = 0;
                    this.velocityY = 0;
                    this.onGround = false;
                    this.character = characters[characterIndex % characters.length];
                    this.isMe = isMe;
                    this.finished = false;
                    this.alive = true;
                    this.direction = 1;
                }
                
                update() {
                    if (!this.alive || !this.isMe) return;
                    
                    if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                        this.velocityX = -MOVE_SPEED;
                        this.direction = -1;
                    }
                    if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                        this.velocityX = MOVE_SPEED;
                        this.direction = 1;
                    }
                    if ((keys['ArrowUp'] || keys['w'] || keys['W'] || keys[' ']) && this.onGround) {
                        this.velocityY = JUMP_FORCE;
                        this.onGround = false;
                    }
                    
                    this.velocityY += GRAVITY;
                    this.x += this.velocityX;
                    this.y += this.velocityY;
                    
                    const groundLevel = canvas.height - 100;
                    if (this.y + this.height >= groundLevel) {
                        this.y = groundLevel - this.height;
                        this.velocityY = 0;
                        this.onGround = true;
                    } else {
                        this.onGround = false;
                    }
                    
                    if (this.x < 0) this.x = 0;
                    if (this.x > WORLD_WIDTH - this.width) this.x = WORLD_WIDTH - this.width;
                    
                    this.velocityX *= 0.85;
                    
                    camera.x = this.x - canvas.width / 2;
                    if (camera.x < 0) camera.x = 0;
                    if (camera.x > WORLD_WIDTH - canvas.width) camera.x = WORLD_WIDTH - canvas.width;
                    
                    enemies.forEach(enemy => {
                        if (this.alive && 
                            this.x < enemy.x + enemy.width &&
                            this.x + this.width > enemy.x &&
                            this.y < enemy.y + enemy.height &&
                            this.y + this.height > enemy.y) {
                            this.alive = false;
                            socket.emit('player-eliminated', {
                                roomId: currentRoom,
                                username: this.username
                            });
                        }
                    });
                    
                    if (this.x >= FINISH_LINE && !this.finished && this.alive) {
                        this.finished = true;
                        finishedPlayers.push({
                            username: this.username,
                            position: finishedPlayers.length + 1,
                            time: Date.now()
                        });
                        
                        socket.emit('player-finished', {
                            roomId: currentRoom,
                            username: this.username,
                            position: finishedPlayers.length
                        });
                    }
                    
                    if (socket) {
                        socket.emit('player-position', {
                            roomId: currentRoom,
                            username: this.username,
                            x: this.x,
                            y: this.y,
                            character: this.character,
                            alive: this.alive
                        });
                    }
                    
                    document.getElementById('distanceCounter').textContent = Math.floor(this.x / 10);
                }
                
                draw() {
                    if (!this.alive) return;
                    
                    const screenX = this.x - camera.x;
                    const screenY = this.y;
                    
                    if (screenX < -50 || screenX > canvas.width + 50) return;
                    
                    ctx.save();
                    if (this.direction === -1) {
                        ctx.scale(-1, 1);
                        ctx.translate(-(screenX + this.width), 0);
                    } else {
                        ctx.translate(screenX, 0);
                    }
                    
                    ctx.fillStyle = this.character.bodyColor;
                    ctx.fillRect(0, screenY + 20, this.width, 20);
                    
                    ctx.fillStyle = this.character.armorColor;
                    ctx.fillRect(2, screenY + 20, this.width - 4, 16);
                    
                    ctx.fillStyle = this.character.bodyColor;
                    ctx.fillRect(6, screenY, 12, 24);
                    
                    ctx.fillStyle = '#FFDBAC';
                    ctx.fillRect(7, screenY + 2, 10, 10);
                    
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(9, screenY + 4, 2, 2);
                    ctx.fillRect(13, screenY + 4, 2, 2);
                    ctx.fillRect(10, screenY + 7, 4, 1);
                    
                    if (this.character.accessory === 'helmet') {
                        ctx.fillStyle = this.character.armorColor;
                        ctx.fillRect(6, screenY - 2, 12, 6);
                    } else if (this.character.accessory === 'hat') {
                        ctx.fillStyle = this.character.armorColor;
                        ctx.fillRect(7, screenY - 4, 10, 4);
                        ctx.fillRect(11, screenY - 8, 2, 4);
                    } else if (this.character.accessory === 'hood') {
                        ctx.fillStyle = this.character.armorColor;
                        ctx.fillRect(5, screenY - 2, 14, 8);
                    } else if (this.character.accessory === 'crown') {
                        ctx.fillStyle = '#FFD700';
                        ctx.fillRect(7, screenY - 3, 10, 3);
                        ctx.fillRect(9, screenY - 5, 2, 2);
                        ctx.fillRect(13, screenY - 5, 2, 2);
                    } else if (this.character.accessory === 'mask') {
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(7, screenY + 2, 10, 4);
                    }
                    
                    ctx.fillStyle = this.character.bodyColor;
                    ctx.fillRect(3, screenY + 40, 6, 8);
                    ctx.fillRect(15, screenY + 40, 6, 8);
                    
                    ctx.restore();
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '8px monospace';
                    ctx.fillText(this.username, screenX - 10, screenY - 10);
                }
            }
            
            class Enemy {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.width = 16;
                    this.height = 16;
                    this.velocityX = (Math.random() - 0.5) * 2;
                    this.velocityY = 0;
                    this.color = '#8B008B';
                    this.bounceTimer = 0;
                }
                
                update() {
                    this.bounceTimer += 0.1;
                    this.velocityY = Math.sin(this.bounceTimer) * 2;
                    
                    this.x += this.velocityX;
                    this.y += this.velocityY;
                    
                    const groundLevel = canvas.height - 100;
                    if (this.y + this.height > groundLevel) {
                        this.y = groundLevel - this.height;
                    }
                    
                    if (this.x <= 100 || this.x >= WORLD_WIDTH - 100) {
                        this.velocityX *= -1;
                    }
                }
                
                draw() {
                    const screenX = this.x - camera.x;
                    const screenY = this.y;
                    
                    if (screenX < -50 || screenX > canvas.width + 50) return;
                    
                    ctx.fillStyle = this.color;
                    ctx.fillRect(screenX, screenY, this.width, this.height);
                    
                    ctx.fillStyle = '#FF0080';
                    ctx.fillRect(screenX + 2, screenY + 2, this.width - 4, this.height - 4);
                    
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(screenX + 4, screenY + 4, 2, 2);
                    ctx.fillRect(screenX + 10, screenY + 4, 2, 2);
                    
                    ctx.fillRect(screenX + 6, screenY + 8, 4, 2);
                }
            }
            
            room.players.forEach((player, index) => {
                const isMe = player.username === currentUser.username;
                const newPlayer = new Player(player.username, index, isMe);
                players.set(player.username, newPlayer);
                if (isMe) myPlayer = newPlayer;
            });
            
            for (let i = 0; i < 20; i++) {
                const x = 200 + Math.random() * (WORLD_WIDTH - 400);
                const y = canvas.height - 150 - Math.random() * 200;
                enemies.push(new Enemy(x, y));
            }
            
            function drawBackground() {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.7, '#87CEEB');
                gradient.addColorStop(0.7, '#90EE90');
                gradient.addColorStop(1, '#228B22');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#FFFFFF';
                for (let i = 0; i < 15; i++) {
                    const x = (i * 200) + Math.sin(Date.now() * 0.001 + i) * 30 - camera.x * 0.3;
                    const y = 30 + Math.sin(Date.now() * 0.0015 + i * 2) * 20;
                    if (x > -100 && x < canvas.width + 100) {
                        drawPixelCloud(x, y);
                    }
                }
                
                ctx.fillStyle = '#228B22';
                ctx.fillRect(0 - camera.x, canvas.height - 100, WORLD_WIDTH, 100);
                
                ctx.fillStyle = '#32CD32';
                for (let i = 0; i < WORLD_WIDTH / 32; i++) {
                    const x = i * 32 - camera.x;
                    if (x > -32 && x < canvas.width + 32) {
                        ctx.fillRect(x, canvas.height - 100, 32, 8);
                    }
                }
                
                for (let i = 0; i < WORLD_WIDTH / 100; i++) {
                    const x = i * 100 + 50 - camera.x;
                    if (x > -50 && x < canvas.width + 50) {
                        drawTree(x, canvas.height - 150);
                    }
                }
            }
            
            function drawPixelCloud(x, y) {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(x, y, 48, 16);
                ctx.fillRect(x - 16, y + 8, 80, 16);
                ctx.fillRect(x + 8, y - 8, 32, 16);
            }
            
            function drawTree(x, y) {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(x - 4, y, 8, 50);
                
                ctx.fillStyle = '#228B22';
                ctx.fillRect(x - 16, y - 20, 32, 32);
                ctx.fillRect(x - 12, y - 32, 24, 24);
                ctx.fillRect(x - 8, y - 40, 16, 16);
            }
            
            function drawObstacles() {
                const obstacles = [
                    { x: 300, y: canvas.height - 150, w: 40, h: 50 },
                    { x: 600, y: canvas.height - 180, w: 60, h: 80 },
                    { x: 1000, y: canvas.height - 140, w: 30, h: 40 },
                    { x: 1400, y: canvas.height - 160, w: 50, h: 60 },
                    { x: 1800, y: canvas.height - 170, w: 40, h: 70 },
                    { x: 2200, y: canvas.height - 150, w: 35, h: 50 },
                    { x: 2600, y: canvas.height - 180, w: 45, h: 80 },
                    { x: 3000, y: canvas.height - 140, w: 40, h: 40 },
                    { x: 3400, y: canvas.height - 160, w: 50, h: 60 },
                    { x: 3800, y: canvas.height - 170, w: 60, h: 70 },
                    { x: 4200, y: canvas.height - 150, w: 40, h: 50 }
                ];
                
                obstacles.forEach(obs => {
                    const screenX = obs.x - camera.x;
                    if (screenX > -obs.w && screenX < canvas.width + obs.w) {
                        ctx.fillStyle = '#8B4513';
                        for (let x = 0; x < obs.w; x += 16) {
                            for (let y = 0; y < obs.h; y += 16) {
                                if ((Math.floor(x / 16) + Math.floor(y / 16)) % 2 === 0) {
                                    ctx.fillStyle = '#8B4513';
                                } else {
                                    ctx.fillStyle = '#A0522D';
                                }
                                ctx.fillRect(screenX + x, obs.y + y, 16, 16);
                            }
                        }
                    }
                });
            }
            
            function drawFinishLine() {
                const screenX = FINISH_LINE - camera.x;
                if (screenX > -50 && screenX < canvas.width + 50) {
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(screenX, 0, 12, canvas.height);
                    
                    for (let y = 0; y < canvas.height; y += 40) {
                        ctx.fillStyle = (Math.floor(y / 40) % 2 === 0) ? '#000000' : '#FFFFFF';
                        ctx.fillRect(screenX, y, 12, 20);
                    }
                    
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(screenX + 16, 50, 6, 150);
                    
                    ctx.fillStyle = '#FF4444';
                    ctx.fillRect(screenX + 22, 50, 40, 25);
                    
                    ctx.fillStyle = '#000000';
                    ctx.font = '16px monospace';
                    ctx.fillText('FINISH!', screenX - 80, 40);
                }
            }
            
            function gameLoop() {
                if (!gameRunning) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                drawBackground();
                drawObstacles();
                drawFinishLine();
                
                enemies.forEach(enemy => {
                    enemy.update();
                    enemy.draw();
                });
                
                players.forEach(player => {
                    player.update();
                    player.draw();
                });
                
                let playersAlive = 0;
                players.forEach(player => {
                    if (player.alive) playersAlive++;
                });
                document.getElementById('playersAlive').textContent = playersAlive;
                
                requestAnimationFrame(gameLoop);
            }
            
            function removePlayer(username) {
                const player = players.get(username);
                if (player) {
                    player.alive = false;
                }
            }
            
            document.addEventListener('keydown', (e) => {
                keys[e.key] = true;
                e.preventDefault();
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.key] = false;
                e.preventDefault();
            });
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
            
            gameLoop();
        }
        
        function updatePlayerPosition(data) {
            const player = gameState.players.get(data.username);
            if (player && data.username !== currentUser.username) {
                player.x = data.x;
                player.y = data.y;
                player.alive = data.alive;
            }
        }
        
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (token) {
                fetch('/api/profile/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Token invalid');
                }).then(data => {
                    currentUser = data;
                    initializeSocket();
                    showMainMenu();
                }).catch(() => {
                    localStorage.removeItem('token');
                    showLogin();
                });
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>